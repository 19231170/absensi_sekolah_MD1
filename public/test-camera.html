<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camera Permission Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            background: #f5f5f5; 
        }
        .container { 
            max-width: 600px; 
            margin: 0 auto; 
            background: white; 
            padding: 30px; 
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        .btn { 
            background: #28a745; 
            color: white; 
            padding: 12px 24px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            font-size: 16px; 
            margin: 10px 5px; 
        }
        .btn:hover { background: #218838; }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }
        .alert { 
            padding: 15px; 
            margin: 15px 0; 
            border-radius: 5px; 
        }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-danger { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .alert-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        #video { 
            width: 100%; 
            max-width: 400px; 
            border: 2px solid #ddd; 
            border-radius: 5px; 
            margin: 10px 0; 
        }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé• Camera Permission Test</h1>
        <p>Use this page to test camera permissions before using the QR scanner.</p>
        
        <div id="status"></div>
        
        <div class="controls">
            <button class="btn" onclick="testCamera()">üìπ Test Camera Access</button>
            <button class="btn btn-danger hidden" id="stopBtn" onclick="stopCamera()">‚èπÔ∏è Stop Camera</button>
        </div>
        
        <video id="video" class="hidden" autoplay playsinline muted></video>
        
        <div id="instructions" class="alert alert-info">
            <h4>üìã Instructions:</h4>
            <ol>
                <li>Click "Test Camera Access" button</li>
                <li>Allow camera access when prompted</li>
                <li>If you see your camera feed, permissions are working</li>
                <li>If not, check the error message below</li>
            </ol>
        </div>
        
        <div id="troubleshooting" class="alert alert-info hidden">
            <h4>üîß Troubleshooting Camera Issues:</h4>
            <ul>
                <li><strong>Permission Denied:</strong> Click the camera icon in address bar and select "Allow"</li>
                <li><strong>Camera Not Found:</strong> Make sure your device has a camera connected</li>
                <li><strong>Camera In Use:</strong> Close other apps that might be using the camera</li>
                <li><strong>HTTPS Required:</strong> Use https:// or localhost for camera access</li>
                <li><strong>Browser Support:</strong> Use Chrome, Firefox, or Safari latest version</li>
            </ul>
        </div>
    </div>

    <script>
        let stream = null;
        const video = document.getElementById('video');
        const statusDiv = document.getElementById('status');
        const stopBtn = document.getElementById('stopBtn');
        const troubleshooting = document.getElementById('troubleshooting');

        function showStatus(message, type = 'info') {
            statusDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
        }

        async function testCamera() {
            try {
                showStatus('üîÑ Requesting camera access...', 'info');
                
                // Request camera permission
                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: { ideal: "environment" },
                        width: { ideal: 1280, min: 640 },
                        height: { ideal: 720, min: 480 }
                    }
                });
                
                // Show video feed
                video.srcObject = stream;
                video.classList.remove('hidden');
                stopBtn.classList.remove('hidden');
                troubleshooting.classList.add('hidden');
                
                showStatus('‚úÖ Camera access granted! Video feed is working.', 'success');
                
                // Get camera info
                const track = stream.getVideoTracks()[0];
                const settings = track.getSettings();
                const capabilities = track.getCapabilities();
                
                console.log('Camera Settings:', settings);
                console.log('Camera Capabilities:', capabilities);
                
                showStatus(`‚úÖ Camera working! Resolution: ${settings.width}x${settings.height}`, 'success');
                
            } catch (error) {
                console.error('Camera Error:', error);
                
                let errorMessage = 'Unknown camera error';
                let troubleshootText = '';
                
                switch(error.name) {
                    case 'NotAllowedError':
                        errorMessage = '‚ùå Camera access denied by user';
                        troubleshootText = 'Click the camera icon in your address bar and select "Allow"';
                        break;
                    case 'NotFoundError':
                        errorMessage = '‚ùå No camera found on this device';
                        troubleshootText = 'Make sure your device has a camera connected and enabled';
                        break;
                    case 'NotReadableError':
                        errorMessage = '‚ùå Camera is being used by another application';
                        troubleshootText = 'Close other apps that might be using the camera and try again';
                        break;
                    case 'OverconstrainedError':
                        errorMessage = '‚ùå Camera does not support requested settings';
                        troubleshootText = 'Your camera may not support the requested resolution or format';
                        break;
                    case 'SecurityError':
                        errorMessage = '‚ùå Camera access blocked for security reasons';
                        troubleshootText = 'Make sure you are using HTTPS or localhost';
                        break;
                    default:
                        errorMessage = `‚ùå Camera error: ${error.message}`;
                        troubleshootText = 'Please check your camera and browser settings';
                }
                
                showStatus(`${errorMessage}<br><small>${troubleshootText}</small>`, 'danger');
                troubleshooting.classList.remove('hidden');
            }
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            
            video.srcObject = null;
            video.classList.add('hidden');
            stopBtn.classList.add('hidden');
            
            showStatus('üì∑ Camera stopped', 'info');
        }

        // Check browser support
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            showStatus('‚ùå Your browser does not support camera access', 'danger');
            troubleshooting.classList.remove('hidden');
        } else {
            showStatus('‚úÖ Browser supports camera access. Click button to test.', 'success');
        }
    </script>
</body>
</html>
